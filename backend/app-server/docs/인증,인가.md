<!-- TOC -->
  * [OIDC 로그인](#oidc-로그인)
  * [액세스 토큰 갱신](#액세스-토큰-갱신)
<!-- TOC -->

## OIDC 로그인



## 액세스 토큰 갱신

```mermaid
sequenceDiagram
    participant cli as 클라이언트(모바일 앱)
    participant sv as 서버
    participant db as DB

Note over cli, sv: 사용자는 앱 사용 중...

%% --- 1. 일반적인 API 성공 사례 ---
cli->>sv: API 요청 (유효한 Access Token)
Note right of sv: DB 조회 없이 Stateless 검증
sv-->>cli: 200 OK (요청 성공)

%% --- 2. 토큰 만료 및 자동 갱신 흐름 ---
loop 1시간 후 
    cli->>sv: API 요청 (만료된 Access Token)
    sv ->> sv: Access Token 만료 확인
    sv-->>cli: 401 Unauthorized (code="A4101")

    %% 토큰 재발급 요청
    cli->>sv: 토큰 재발급 요청 (POST /api/v1/auth/token/refresh)<br>Authorization: Bearer {Refresh Token}
    sv ->> sv: 토큰에서 user_id 추출
    sv ->> db: user_id에 해당하는 Refresh Token 조회
    sv ->> sv: 유효성 검증
    
    alt 유효한 Refresh Token
        Note over sv: 리프레쉬 토큰 존재 & 만료되지 않음 
        sv->>db: 새 Refresh Token으로 갱신
        sv-->>cli: 200 OK (새 Access Token + 새 Refresh Token)
        Note over cli: 새로 받은 토큰 저장, 이후 요청에 사용
    else 유효하지 않은 Refresh Token
        Note over sv: 리프레쉬 토큰 없음 or 토큰 만료
        sv-->>cli: 401 Unauthorized (code="A4102")
        cli ->> cli: 로그아웃 처리<br>("유저에게 인증이 만료되었습니다 안내,<br>로그인 화면 이동")
        cli ->> sv: 로그인
        sv -->> cli: 200 OK (새 Access Token + 새 Refresh Token)
    end 

end
```

- 공격자 탈취할 때 별도의 에러 코드를 내려주도록 개선 필요.
  - case1. 리프레쉬 토큰 만료: 정상 케이스
    - 401 Unauthorized, code="A4102" 리턴
  - case2. 토큰 없음/불일치: 탈취 케이스. 리프레쉬 토큰이 다른 사용자에 의해 먼저 사용됨.
    - 401 Unauthorized, code="A4103" 리턴